# 테이블 검증 규칙, 표시 조건, 조건부 분기 버그 수정 요약

## 수정된 버그

### 1. 테이블 응답 데이터 구조 불일치 (치명적 버그) ✅

**문제**: `getBranchRuleForTable` 함수가 중첩 구조 `{ rowId: { cellId: value } }`를 기대했지만, 실제로는 평면 구조 `{ "cell-id": value }`로 데이터가 저장됨

**수정**: `src/utils/branch-logic.ts`의 `getBranchRuleForTable` 함수를 평면 구조로 변경

**영향**: 테이블 질문에서 셀의 `branchRule`이 이제 정상적으로 작동함

### 2. 라디오/체크박스/셀렉트 옵션 값 불일치 ✅

**문제**:

- 응답은 `optionId` (옵션의 `id`)를 저장
- `expectedValues`는 옵션의 `value`를 저장
- `checkTableValidationRule`에서 이 불일치를 처리하지 않음

**수정**: `src/utils/branch-logic.ts`의 `checkTableValidationRule` 함수에서:

- 라디오 버튼: `optionId`를 찾아서 해당 옵션의 `value`로 변환 후 `expectedValues`와 비교
- 체크박스: `optionId` 배열을 `value` 배열로 변환 후 비교
- 셀렉트: `optionId`를 찾아서 해당 옵션의 `value`로 변환 후 비교

**영향**: 테이블 검증 규칙에서 "확인할 옵션 선택" 기능이 이제 정상적으로 작동함

### 3. 표시 조건 평가 로직 검증 ✅

**확인 결과**: 표시 조건 평가 로직은 정상적으로 작동함

- `shouldDisplayQuestion`은 `allResponses`를 받아 이전 질문의 응답만 확인
- 현재 질문의 응답은 포함되지 않으므로 순환 참조 문제 없음

## 테스트 가이드

### 테스트 케이스 1: 테이블 검증 규칙 - 독점 체크

1. 테이블 질문 생성 (최소 3개 행, 1개 열)
2. 첫 번째 열에 라디오 버튼 셀 설정
3. 규칙 추가:
   - 검증 타입: 독점 체크
   - 체크할 행: 3번 행만 선택
   - 특정 열: 0
   - 체크 타입: 라디오 버튼
   - 확인할 옵션: 비워둠
   - 동작: 설문 종료
4. 테스트:
   - ✅ 3번 행만 체크 → 설문 종료되어야 함
   - ✅ 3번과 4번 행 체크 → 설문 계속되어야 함
   - ✅ 4번 행만 체크 → 설문 계속되어야 함

### 테스트 케이스 2: 테이블 검증 규칙 - 확인할 옵션 선택

1. 테이블 질문 생성 (라디오 버튼 셀 포함)
2. 규칙 추가:
   - 검증 타입: 독점 체크
   - 체크할 행: 3번 행 선택
   - 특정 열: 0
   - 체크 타입: 라디오 버튼
   - 확인할 옵션: 특정 옵션 선택 (예: "보유함")
   - 동작: 설문 종료
3. 테스트:
   - ✅ 지정한 옵션 선택 → 설문 종료되어야 함
   - ✅ 다른 옵션 선택 → 설문 계속되어야 함

### 테스트 케이스 3: 표시 조건 - 값 일치

1. 질문 1: 라디오 버튼 (예/아니오)
2. 질문 2: 표시 조건 설정 (질문 1 = "예"일 때만 표시)
3. 테스트:
   - ✅ 질문 1에서 "예" 선택 → 질문 2 표시되어야 함
   - ✅ 질문 1에서 "아니오" 선택 → 질문 2 숨겨져야 함

### 테스트 케이스 4: 표시 조건 - 테이블 셀 체크

1. 질문 1: 테이블 질문
2. 질문 2: 표시 조건 설정 (질문 1의 특정 행 체크 시 표시)
3. 테스트:
   - ✅ 조건 만족 시 질문 2 표시
   - ✅ 조건 불만족 시 질문 2 숨김

### 테스트 케이스 5: 조건부 분기 - goto

1. 질문 1: 라디오 버튼 (옵션별로 다른 질문으로 이동)
2. 테스트:
   - ✅ 각 옵션 선택 시 올바른 질문으로 이동하는지 확인

### 테스트 케이스 6: 조건부 분기 - 설문 종료

1. 질문 1: 라디오 버튼 (특정 옵션 선택 시 설문 종료)
2. 테스트:
   - ✅ 설문 종료 옵션 선택 시 완료 화면 표시
   - ✅ 다른 옵션 선택 시 다음 질문으로 이동

## 수정된 파일

1. `src/utils/branch-logic.ts`
   - `getBranchRuleForTable`: 평면 구조로 변경, optionId 기반 검색으로 수정
   - `checkTableValidationRule`: 라디오/체크박스/셀렉트에서 optionId → value 변환 로직 추가

## 검증 완료 사항

- ✅ 테이블 응답 데이터 구조 일치
- ✅ 라디오/체크박스/셀렉트 옵션 값 변환 로직
- ✅ 표시 조건 평가 로직 (순환 참조 없음)

## 다음 단계

실제 설문 페이지에서 위 테스트 케이스들을 실행하여 모든 기능이 정상 작동하는지 확인하세요.
